"use strict";var M=Object.create;var R=Object.defineProperty;var W=Object.getOwnPropertyDescriptor;var L=Object.getOwnPropertyNames;var H=Object.getPrototypeOf,N=Object.prototype.hasOwnProperty;var G=(e,n,r,i)=>{if(n&&typeof n=="object"||typeof n=="function")for(let o of L(n))!N.call(e,o)&&o!==r&&R(e,o,{get:()=>n[o],enumerable:!(i=W(n,o))||i.enumerable});return e};var S=(e,n,r)=>(r=e!=null?M(H(e)):{},G(n||!e||!e.__esModule?R(r,"default",{value:e,enumerable:!0}):r,e));var t=S(require("@actions/core")),y=S(require("@actions/exec"));async function V(){try{let e=t.getInput("api_token",{required:!0}),n=t.getInput("wrangler_command",{required:!0}),r=t.getInput("working_directory")||"",o=(t.getInput("only_upload")||"false").toLowerCase()==="true",s=t.getInput("config",{required:!0}),f=t.getInput("upload_args")||"",I=t.getInput("deploy_args")||"",m=t.getInput("message_template")||"",_=t.getInput("tag_template")||"",g=C(f),w=C(I),U=r.trim().length>0?r.trim():void 0,h=n.trim();if(!e){t.setFailed("Cloudflare API token (api_token) is required.");return}let c=await q();t.info([`Repository: ${c.owner??"unknown"}/${c.repo??"unknown"}`,`Branch: ${c.branch??c.ref??"unknown"}`,`SHA: ${c.sha??"unknown"}`,`Actor: ${c.actor??"unknown"}`,`Run: #${c.run_number??"?"} (ID: ${c.run_id??"?"})`].join(" | "));let O={...c,deployment_url:void 0,version_id:void 0},a=m?B(m,O):Y(c),p=_?B(_,O):Z(c);t.info(`Using deployment message: ${a}`),p&&t.info(`Using deployment tag: ${p}`);let k=["versions","upload",...s?["--config",s]:[],...g,`--message=${a}`];t.info(`Running upload: ${h} ${k.join(" ")}`);let T="",x="",P={env:{...process.env,CLOUDFLARE_API_TOKEN:e},cwd:U,listeners:{stdout:d=>{let l=d.toString();T+=l},stderr:d=>{let l=d.toString();x+=l}}},b=await y.exec(h,k,P);if(b!==0){x.trim()&&t.error(x.trimEnd()),t.setFailed(`wrangler versions upload failed with exit code ${b}. See logs above for details.`);return}let u=z(T);if(o){u?(t.info(`Parsed Worker Version ID (only_upload=true): ${u}`),t.setOutput("version_id",u)):t.info("only_upload=true and no Worker Version ID could be parsed; exiting successfully."),a&&t.setOutput("message",a),p&&t.setOutput("tag",p);return}if(!u){t.setFailed("Failed to parse Worker Version ID from wrangler versions upload output.");return}t.info(`Parsed Worker Version ID: ${u}`);let A=["versions","deploy",u,"-y",...s?["--config",s]:[],...w,`--message=${a}`];t.info(`Running deploy: ${h} ${A.join(" ")}`);let D="",v="",F={env:{...process.env,CLOUDFLARE_API_TOKEN:e},cwd:U,listeners:{stdout:d=>{let l=d.toString();D+=l},stderr:d=>{let l=d.toString();v+=l}}},E=await y.exec(h,A,F);if(E!==0){v.trim()&&t.error(v.trimEnd()),t.setFailed(`wrangler versions deploy failed with exit code ${E}. See logs above for details.`);return}let{deploymentUrl:$}=K(D);$?(t.info(`Detected deployment URL: ${$}`),t.setOutput("deployment_url",$)):t.info("No deployment URL detected from Wrangler deploy output. If this is unexpected, please open an issue with example logs."),t.setOutput("version_id",u),a&&t.setOutput("message",a),p&&t.setOutput("tag",p)}catch(e){let n=J(e);t.setFailed(n.message||String(n))}}async function q(){let e=process.env.GITHUB_REPOSITORY,[n,r]=e?e.split("/"):[void 0,void 0],i=process.env.GITHUB_SHA,o=i?i.substring(0,7):void 0,s=process.env.GITHUB_REF,f=s&&s.startsWith("refs/heads/")?s.substring(11):void 0,I=process.env.GITHUB_ACTOR,m=process.env.GITHUB_RUN_ID,_=process.env.GITHUB_RUN_NUMBER,g=await j(),w=g?g.split(`
`)[0]:void 0;return{repo:r,owner:n,ref:s,branch:f,sha:i,short_sha:o,actor:I,run_id:m,run_number:_,commit_message:g,short_commit_message:w}}async function j(){try{let e="";await y.exec("git",["log","-1","--pretty=%B"],{listeners:{stdout:r=>{e+=r.toString()}},silent:!0});let n=e.trim();return n.length>0?n:void 0}catch{return}}function B(e,n){return e.replace(/{{\s*([a-zA-Z0-9_]+)\s*}}/g,(r,i)=>{let o=n[i];return o!==void 0?String(o):""})}function C(e){if(!e.trim())return[];let n=[],r="",i=null;for(let o=0;o<e.length;o++){let s=e[o];if(i){s===i?i=null:r+=s;continue}if(s==="'"||s==='"'){i=s;continue}if(/\s/.test(s)){r&&(n.push(r),r="");continue}r+=s}return r&&n.push(r),n}function K(e){let n={},r=e.match(/https?:\/\/[^\s"]+/);return r&&(n.deploymentUrl=r[0]),n}function z(e){return e.match(/Worker Version ID:\s*([0-9a-fA-F-]+)/)?.[1]}function Y(e){let n=e.branch||"",r=e.short_sha||(e.sha?e.sha.substring(0,6):""),i=e.short_commit_message||e.commit_message||"",o=[];n?r?o.push(`${n}@${r}`):o.push(n):r&&o.push(r);let s=o.join("");return(s?`${s}: ${i}`:i).slice(0,100)}function Z(e){return""}function J(e){return e instanceof Error?e:new Error(typeof e=="string"?e:"Unknown error")}V();
//# sourceMappingURL=index.js.map